@page
@model project_pharmacie.Areas.Staff.Pages.Suppliers.IndexModel
@{
    ViewData["Title"] = "Fournisseurs";
}

<div class="mx-auto max-w-6xl px-4 py-6">

    <!-- Header (même style que Dashboard) -->
    <div class="mb-2 flex flex-col gap-4 sm:flex-row sm:items-end sm:justify-between">
        <div>
            <h1 class="text-2xl font-semibold tracking-tight">
                Fournisseurs
            </h1>
        </div>

        <div class="flex gap-2">
            <a asp-area="Staff" asp-page="/Dashboard/Index"
               class="rounded-xl border bg-white px-4 py-2 text-sm hover:bg-zinc-50">
                ← Dashboard
            </a>

            <a asp-area="Staff" asp-page="/Orders/Create"
               class="rounded-xl bg-zinc-900 px-4 py-2 text-sm font-medium text-white hover:bg-zinc-800">
                Passer commande
            </a>
        </div>
    </div>

    <p class="mb-6 text-sm text-zinc-500">
        Tri par note et moyenne.
    </p>

    <partial name="/Areas/Admin/Pages/Shared/_Flash.cshtml" />

    @* Toast Success *@
    @if (TempData["Toast.Success"] is string toast && !string.IsNullOrWhiteSpace(toast))
    {
        <div id="toast-success" class="mb-4 rounded-2xl border border-emerald-200 bg-emerald-50 p-4 text-sm text-emerald-800">
            @toast
        </div>
    }

    <!-- KPIs (même style que Dashboard) -->
    <div class="mb-6 grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
        <div class="rounded-2xl border bg-white p-4">
            <p class="text-sm text-zinc-500">Total fournisseurs</p>
            <p class="mt-2 text-2xl font-semibold text-zinc-900">@Model.TotalSuppliers</p>
        </div>

        <div class="rounded-2xl border bg-white p-4">
            <p class="text-sm text-zinc-500">Note moyenne</p>
            <p class="mt-2 text-2xl font-semibold text-zinc-900">@Model.AverageRating.ToString("N1") / 5</p>
            <p class="mt-1 text-xs text-zinc-500">basée sur @Model.TotalRatingsCount évaluations</p>
        </div>

        <div class="rounded-2xl border bg-white p-4">
            <p class="text-sm text-zinc-500">Meilleur fournisseur</p>
            <p class="mt-2 text-2xl font-semibold text-zinc-900">@Model.BestSupplierName</p>
            <p class="mt-1 text-xs text-zinc-500">@Model.BestSupplierRating.ToString("N1") / 5</p>
        </div>
    </div>

    <!-- Tri (même style "barre" que Dashboard table header) -->
    <div class="overflow-hidden rounded-2xl border bg-white mb-4">
        <div class="flex flex-col gap-3 border-b bg-white p-4 sm:flex-row sm:items-end sm:justify-between">
            <div>
                <h2 class="text-base font-semibold text-zinc-900">Liste</h2>
                <p class="text-sm text-zinc-500">Trie la liste pour choisir rapidement le meilleur fournisseur.</p>
            </div>

            <div class="flex flex-wrap gap-2">
                @{
                    string Btn(string sort)
                    {
                        var active = string.Equals(Model.Sort, sort, System.StringComparison.OrdinalIgnoreCase);
                        return active
                        ? "rounded-xl bg-zinc-900 px-4 py-2 text-sm font-medium text-white hover:bg-zinc-800"
                        : "rounded-xl border bg-white px-4 py-2 text-sm hover:bg-zinc-50";
                    }
                }

                <a asp-area="Staff" asp-page="/Suppliers/Index" asp-route-sort="rating_desc" class="@Btn("rating_desc")">Note ↓</a>
                <a asp-area="Staff" asp-page="/Suppliers/Index" asp-route-sort="rating_asc" class="@Btn("rating_asc")">Note ↑</a>
                <a asp-area="Staff" asp-page="/Suppliers/Index" asp-route-sort="name" class="@Btn("name")">Nom A→Z</a>
            </div>
        </div>

        <!-- Table (même style que Dashboard / Clients/Index) -->
        <table class="min-w-full text-left text-sm">
            <thead class="bg-zinc-50 text-zinc-600">
                <tr>
                    <th class="px-4 py-3 font-medium">Fournisseur</th>
                    <th class="px-4 py-3 font-medium">Téléphone</th>
                    <th class="px-4 py-3 font-medium">Note</th>
                    <th class="px-4 py-3 font-medium">Nb avis</th>
                    <th class="px-4 py-3 font-medium">Statut</th>
                    <th class="px-4 py-3 font-medium text-right">Actions</th>
                </tr>
            </thead>

            <tbody class="divide-y">
                @if (Model.Rows == null || Model.Rows.Count == 0)
                {
                    <tr>
                        <td colspan="6" class="px-4 py-10 text-center">
                            <p class="text-base font-semibold">Aucun fournisseur</p>
                            <p class="mt-1 text-sm text-zinc-500">Ajoute des fournisseurs (ou branche la DB).</p>
                        </td>
                    </tr>
                }
                else
                {
                    foreach (var s in Model.Rows)
                    {
                        var (badgeCls, badgeText) = Model.GetRatingBadge(s.Rating);

                        <tr class="hover:bg-zinc-50/50">
                            <td class="px-4 py-3">
                                <span class="font-medium text-zinc-900">@s.Name</span>
                            </td>

                            <td class="px-4 py-3 text-zinc-700">@s.Phone</td>

                            <td class="px-4 py-3">
                                <span class="rounded-full px-2 py-1 text-xs font-medium ring-1 ring-inset @badgeCls">
                                    @badgeText • @s.Rating.ToString("N1")/5
                                </span>
                            </td>

                            <td class="px-4 py-3 text-zinc-700">@s.RatingsCount</td>

                            <td class="px-4 py-3">
                                @if (s.IsPreferred)
                                {
                                    <span class="rounded-full bg-emerald-50 px-2 py-1 text-xs font-medium text-emerald-700">
                                        Préféré
                                    </span>
                                }
                                else
                                {
                                    <span class="rounded-full bg-zinc-100 px-2 py-1 text-xs font-medium text-zinc-700">
                                        Standard
                                    </span>
                                }
                            </td>

                            <td class="px-4 py-3 text-right">
                                <div class="flex justify-end gap-2">
                                    <a asp-area="Staff" asp-page="/Orders/Create" asp-route-supplierId="@s.Id"
                                       class="rounded-xl bg-zinc-900 px-3 py-1.5 text-sm font-medium text-white hover:bg-zinc-800">
                                        Commander
                                    </a>

                                    <a asp-area="Staff" asp-page="/Suppliers/Rate" asp-route-supplierId="@s.Id"
                                       class="rounded-xl border bg-white px-3 py-1.5 text-sm hover:bg-zinc-50">
                                        Noter
                                    </a>
                                </div>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>

    <script>
        (function () {
          const el = document.getElementById("toast-success");
          if (!el) return;
          setTimeout(() => {
            el.style.transition = "opacity 250ms ease";
            el.style.opacity = "0";
            setTimeout(() => el.remove(), 300);
          }, 3000);
        })();
    </script>
</div>